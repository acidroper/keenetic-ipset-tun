# Маршрутизация трафика по доменам для Keenetic

Этот репозиторий содержит скрипты и конфигурации для маршрутизации трафика определённых доменных имён через туннель на маршрутизаторах Keenetic, что позволяет обходить блокировки.

Эта настройка использует следующие инструменты:

- `dnsmasq`: Динамически обновляет `ipset` IP-адресами, полученными для указанных доменов.
- `dnscrypt`: Защищает DNS-запросы с помощью DNS-over-HTTPS.
- `iptables`: Маркирует пакеты, принадлежащие IP-адресам из `ipset`.
- `ip route`: Настраивает таблицы маршрутизации для направления маркированного трафика через туннель.
- Shadowsocks или другой прокси/VPN: Устанавливает зашифрованный туннель для выборочной маршрутизации трафика.

---

> [!NOTE]  
> Для работы по этой схеме предварительно должны быть установлены компоненты OPKG для использования системы пакетов репозитория Entware.
> 
> А также для преобразования доменных имён через `dnsmasq` необходимо отключить встроенный в Keenetic DNS-сервер следующими командами в CLI:
> `opkg dns-override`, `system configuration save`

## Принцип работы

### Общая концепция

Это решение для роутеров Keenetic, которое позволяет направлять трафик к определённым сайтам (доменам) через зашифрованный туннель (в данном случае, созданный с помощью Shadowsocks), в то время как остальной трафик идёт напрямую. Это классический пример `split-tunneling` (раздельного туннелирования), основанного на доменных именах.

### Компоненты и их взаимодействие

Работа системы строится на совместной работе нескольких компонентов: `Shadowsocks` (или другой прокси/VPN), `dnsmasq`, `dnscrypt-proxy`, `ipset` и скриптов для `iptables`.

Вот пошаговое описание процесса:

**1. Создание туннеля и базовой маршрутизации (при старте роутера)**

*   [`opt/etc/shadowsocks-rust.json`](opt/etc/shadowsocks-rust.json): Конфигурационный файл для клиента `shadowsocks-rust`, который создает виртуальный сетевой интерфейс `tun0`.
*   [`opt/etc/ndm/fs.d/100-tun0-interface.sh`](opt/etc/ndm/fs.d/100-tun0-interface.sh): Скрипт создает интерфейс `tun0` при старте системы.
*   [`opt/etc/ndm/fs.d/110-ipset_and_routing_table_v4.sh`](opt/etc/ndm/fs.d/110-ipset_and_routing_table_v4.sh) и [`opt/etc/ndm/fs.d/111-ipset_and_routing_table_v6.sh`](opt/etc/ndm/fs.d/111-ipset_and_routing_table_v6.sh): Эти скрипты создают:
    *   `ipset`-ы `unblock4` и `unblock6` для хранения IP-адресов.
    *   Отдельную таблицу маршрутизации (`table 1`) и правило (`ip rule add fwmark 1 table 1`), которое направляет весь трафик с меткой `1` в эту таблицу.
    *   Маршрут по умолчанию в `table 1`, который направляет весь трафик в интерфейс `tun0`.

**2. Обработка DNS-запросов (ключевой этап)**

*   Когда устройство в локальной сети запрашивает домен (например, `facebook.com`), запрос приходит на `dnsmasq` роутера.
*   `dnsmasq` ([`opt/etc/dnsmasq.conf`](opt/etc/dnsmasq.conf)) перенаправляет запрос на `dnscrypt-proxy` (`127.0.0.1#5335`).
*   `dnscrypt-proxy` ([`opt/etc/dnscrypt-proxy.toml`](opt/etc/dnscrypt-proxy.toml)) безопасно (через DoH) получает IP-адрес и возвращает его `dnsmasq`.
*   `dnsmasq` видит директиву `ipset=/.../facebook.com/.../unblock4,unblock6` и **добавляет полученный IP-адрес в `ipset`-ы `unblock4` и `unblock6`**.
*   `dnsmasq` возвращает IP-адрес клиенту.

**3. Маркировка и перенаправление трафика**

*   Клиент начинает отправлять пакеты на полученный IP-адрес.
*   [`opt/etc/ndm/netfilter.d/100-fwmarks_v4.sh`](opt/etc/ndm/netfilter.d/100-fwmarks_v4.sh) и [`opt/etc/ndm/netfilter.d/101-fwmarks_v6.sh`](opt/etc/ndm/netfilter.d/101-fwmarks_v6.sh): Эти скрипты настраивают `iptables`. Правила проверяют, принадлежит ли IP-адрес назначения пакета `ipset`-у `unblock4` или `unblock6`. Если да, то **соединение помечается меткой `1`**.
*   Ядро системы видит метку `1` и, согласно правилу `ip rule`, использует таблицу маршрутизации `1`.
*   Таблица `1` направляет пакет в интерфейс `tun0`, то есть в туннель.
*   Скрипты [`opt/etc/ndm/netfilter.d/110-tun0-nat_v4.sh`](opt/etc/ndm/netfilter.d/110-tun0-nat_v4.sh), [`opt/etc/ndm/netfilter.d/110-tun0-nat_v6.sh`](opt/etc/ndm/netfilter.d/110-tun0-nat_v6.sh), [`opt/etc/ndm/netfilter.d/110-tun0-filter_v4.sh`](opt/etc/ndm/netfilter.d/110-tun0-filter_v4.sh) и [`opt/etc/ndm/netfilter.d/110-tun0-filter_v6.sh`](opt/etc/ndm/netfilter.d/110-tun0-filter_v6.sh) обеспечивают корректную работу NAT и прохождение трафика через файрвол для туннельного интерфейса.

### Сводка процесса

1.  **Запуск:** Роутер создает туннель, `ipset`-ы и правила маршрутизации.
2.  **DNS-запрос:** Клиент запрашивает домен из списка в `dnsmasq.conf`.
3.  **Наполнение `ipset`:** `dnsmasq` разрешает домен в IP и автоматически добавляет этот IP в `ipset`.
4.  **Маркировка трафика:** `iptables` видит трафик на IP из `ipset` и ставит на него метку.
5.  **Перенаправление:** Ядро направляет маркированный трафик в туннель.
6.  **Остальной трафик:** Если домена нет в списке, его трафик идет напрямую, мимо туннеля.
